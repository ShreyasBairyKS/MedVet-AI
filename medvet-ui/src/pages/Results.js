import React from 'react';
import { useLocation, Link } from 'react-router-dom';
import { motion } from 'framer-motion';
import { AlertCircle, CheckCircle, Clock, AlertTriangle, ArrowRight, Download, Share2, TrendingUp, Activity } from 'lucide-react';

const Results = () => {
  const location = useLocation();
  const { report, urgency_json } = location.state || {};

  if (!report) {
    return (
      <div className="min-h-screen pt-24 pb-12 px-4">
        <div className="max-w-4xl mx-auto text-center">
          <AlertCircle className="w-20 h-20 text-gray-400 mx-auto mb-4" />
          <h2 className="text-2xl font-bold text-gray-800 mb-4">No Results Found</h2>
          <p className="text-gray-600 mb-8">Please submit a diagnosis first</p>
          <Link to="/diagnose">
            <button className="px-6 py-3 bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-600 text-white rounded-full font-semibold shadow-lg hover:shadow-xl transition-all glow-hover">
              Start Diagnosis
            </button>
          </Link>
        </div>
      </div>
    );
  }

  const handleDownloadReport = () => {
    // Create formatted text content
    const timestamp = new Date().toLocaleString();
    const urgencyLevel = urgency_json?.triage_level || 'UNKNOWN';
    const urgencyScore = urgency_json?.urgency_score || 'N/A';
    const timeframe = urgency_json?.recommended_timeframe || 'Consult healthcare provider';

    const content = `
MEDICAL ANALYSIS REPORT
Generated: ${timestamp}

═══════════════════════════════════════════════════════════════

URGENCY ASSESSMENT
═══════════════════════════════════════════════════════════════

Triage Level: ${urgencyLevel}
Urgency Score: ${urgencyScore}/100
Recommended Timeframe: ${timeframe}

═══════════════════════════════════════════════════════════════

DETAILED ANALYSIS
═══════════════════════════════════════════════════════════════

${report}

═══════════════════════════════════════════════════════════════

IMPORTANT MEDICAL DISCLAIMER
═══════════════════════════════════════════════════════════════

This is NOT a medical or veterinary diagnosis. This information is for 
educational purposes only. Always consult with a qualified healthcare 
professional or veterinarian before taking any action based on this report. 
In case of emergency, seek immediate medical attention.

═══════════════════════════════════════════════════════════════

Report Generated by MedVet AI
${timestamp}
    `.trim();

    // Create blob and download
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `MedVet_Analysis_Report_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const getUrgencyConfig = (level) => {
    switch (level) {
      case 'RED':
        return {
          color: 'from-red-500 to-red-600',
          bg: 'bg-red-50',
          border: 'border-red-500',
          text: 'text-red-700',
          icon: AlertTriangle,
          label: 'URGENT',
          description: 'Immediate medical attention required'
        };
      case 'YELLOW':
        return {
          color: 'from-yellow-500 to-orange-500',
          bg: 'bg-yellow-50',
          border: 'border-yellow-500',
          text: 'text-yellow-700',
          icon: Clock,
          label: 'MODERATE',
          description: 'Schedule appointment soon'
        };
      case 'GREEN':
        return {
          color: 'from-green-500 to-green-600',
          bg: 'bg-green-50',
          border: 'border-green-500',
          text: 'text-green-700',
          icon: CheckCircle,
          label: 'ROUTINE',
          description: 'Standard medical consultation'
        };
      default:
        return {
          color: 'from-gray-500 to-gray-600',
          bg: 'bg-gray-50',
          border: 'border-gray-500',
          text: 'text-gray-700',
          icon: Activity,
          label: 'UNKNOWN',
          description: 'Consultation recommended'
        };
    }
  };

  const urgency = getUrgencyConfig(urgency_json?.triage_level);
  const UrgencyIcon = urgency.icon;

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1
      }
    }
  };

  const itemVariants = {
    hidden: { y: 20, opacity: 0 },
    visible: { y: 0, opacity: 1 }
  };

  return (
    <div className="min-h-screen pt-24 pb-12 px-4">
      <div className="max-w-5xl mx-auto">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: -20 }}
          animate={{ opacity: 1, y: 0 }}
          className="mb-8"
        >
          <Link to="/diagnose" className="inline-flex items-center text-cyan-600 hover:text-purple-600 transition-colors mb-4 font-medium">
            <ArrowRight className="w-5 h-5 mr-2 rotate-180" />
            Start New Diagnosis
          </Link>
          <h1 className="text-4xl font-bold bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-600 bg-clip-text text-transparent mb-2">Analysis Complete</h1>
          <p className="text-gray-600">Your detailed medical analysis report is ready</p>
        </motion.div>

        <motion.div
          variants={containerVariants}
          initial="hidden"
          animate="visible"
          className="space-y-6"
        >
          {/* Urgency Banner */}
          <motion.div variants={itemVariants}>
            <div className={`${urgency.bg} border-l-4 ${urgency.border} rounded-2xl p-6 shadow-lg`}>
              <div className="flex items-start gap-4">
                <div className={`p-3 bg-gradient-to-r ${urgency.color} rounded-xl`}>
                  <UrgencyIcon className="w-8 h-8 text-white" />
                </div>
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-2">
                    <span className={`text-2xl font-bold ${urgency.text}`}>{urgency.label}</span>
                    <span className={`px-3 py-1 ${urgency.bg} border ${urgency.border} rounded-full text-sm font-semibold ${urgency.text}`}>
                      {urgency_json?.triage_level}
                    </span>
                  </div>
                  <p className={`text-lg font-medium ${urgency.text} mb-2`}>{urgency.description}</p>
                  <p className={`${urgency.text} opacity-90`}>
                    Recommended timeframe: <strong>{urgency_json?.recommended_timeframe}</strong>
                  </p>
                  {urgency_json?.urgency_score && (
                    <div className="mt-4">
                      <div className="flex items-center gap-2 mb-2">
                        <TrendingUp className="w-5 h-5" />
                        <span className="font-semibold">Urgency Score</span>
                      </div>
                      <div className="w-full bg-white rounded-full h-3 overflow-hidden">
                        <motion.div
                          initial={{ width: 0 }}
                          animate={{ width: `${urgency_json.urgency_score}%` }}
                          transition={{ duration: 1, delay: 0.3 }}
                          className={`h-full bg-gradient-to-r ${urgency.color}`}
                        />
                      </div>
                      <p className="text-sm mt-1">{urgency_json.urgency_score}/100</p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </motion.div>

          {/* Action Buttons */}
          <motion.div variants={itemVariants} className="flex flex-wrap gap-4">
            <motion.button
              whileHover={{ scale: 1.05, y: -2 }}
              whileTap={{ scale: 0.95 }}
              onClick={handleDownloadReport}
              className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-cyan-100 to-blue-100 border-2 border-cyan-300 rounded-xl font-semibold text-cyan-700 hover:border-cyan-500 transition-all shadow-md hover:shadow-lg"
            >
              <Download className="w-5 h-5" />
              Download Report
            </motion.button>
            <motion.button
              whileHover={{ scale: 1.05, y: -2 }}
              whileTap={{ scale: 0.95 }}
              className="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-100 to-pink-100 border-2 border-purple-300 rounded-xl font-semibold text-purple-700 hover:border-purple-500 transition-all shadow-md hover:shadow-lg"
            >
              <Share2 className="w-5 h-5" />
              Share with Doctor
            </motion.button>
          </motion.div>

          {/* Main Report Card */}
          <motion.div variants={itemVariants}>
            <div className="bg-gradient-to-br from-white via-blue-50 to-purple-50 rounded-2xl shadow-xl p-8 border-2 border-cyan-200">
              <div className="flex items-center gap-3 mb-6 pb-6 border-b-2 border-gradient-to-r from-cyan-200 to-purple-200">
                <motion.div
                  animate={{ rotate: [0, 360] }}
                  transition={{ duration: 10, repeat: Infinity, ease: "linear" }}
                >
                  <Activity className="w-8 h-8 text-cyan-500" />
                </motion.div>
                <h2 className="text-2xl font-bold bg-gradient-to-r from-cyan-600 to-purple-600 bg-clip-text text-transparent">Detailed Analysis Report</h2>
              </div>
              <div className="prose prose-lg max-w-none">
                <div className="space-y-6 leading-relaxed">
                  {report.split('\n').map((line, index) => {
                    const trimmedLine = line.trim();
                    
                    // Main title (##...##)
                    if (line.match(/^\*\*.*\*\*$/)) {
                      return (
                        <h2 key={index} className="text-2xl font-bold text-primary mt-8 mb-4 pb-3 border-b-2 border-primary/20">
                          {line.replace(/^\*\*|\*\*$/g, '')}
                        </h2>
                      );
                    }
                    // Section headers (##Number##)
                    else if (line.match(/^\*\*\d+\).*\*\*$/)) {
                      return (
                        <h3 key={index} className="text-xl font-bold text-gray-800 mt-6 mb-3 flex items-center gap-2">
                          <span className="w-8 h-8 flex items-center justify-center bg-primary/10 text-primary rounded-full text-sm font-bold">
                            {line.match(/\d+/)[0]}
                          </span>
                          {line.replace(/^\*\*\d+\)\s*|\*\*$/g, '')}
                        </h3>
                      );
                    }
                    // Bold subheadings
                    else if (line.match(/^\*\*.*\*\*:?$/)) {
                      return (
                        <h4 key={index} className="text-lg font-semibold text-gray-800 mt-4 mb-2">
                          {line.replace(/^\*\*|\*\*:?$/g, '')}
                        </h4>
                      );
                    }
                    // Bullet points
                    else if (trimmedLine.match(/^[•\-\*]\s*\*\*/)) {
                      const content = trimmedLine.replace(/^[•\-\*]\s*/, '');
                      const [boldPart, ...rest] = content.split('**');
                      return (
                        <div key={index} className="flex items-start gap-3 ml-4 my-3 p-4 bg-white/60 rounded-lg border-l-4 border-primary/30 hover:border-primary/50 transition-colors">
                          <span className="w-2 h-2 bg-primary rounded-full mt-2 flex-shrink-0"></span>
                          <p className="text-gray-700 flex-1">
                            <strong className="text-gray-900 font-semibold">{boldPart.replace('**', '')}</strong>
                            {rest.join('**').replace(/^\*\*/, '')}
                          </p>
                        </div>
                      );
                    }
                    // Regular bullet points
                    else if (trimmedLine.match(/^[•\-\*]\s/)) {
                      return (
                        <div key={index} className="flex items-start gap-3 ml-4 my-2">
                          <span className="w-1.5 h-1.5 bg-primary/60 rounded-full mt-2.5 flex-shrink-0"></span>
                          <p className="text-gray-700">{trimmedLine.replace(/^[•\-\*]\s*/, '')}</p>
                        </div>
                      );
                    }
                    // Empty lines
                    else if (trimmedLine === '') {
                      return <div key={index} className="h-2"></div>;
                    }
                    // Regular paragraphs
                    else {
                      // Handle inline bold text
                      const parts = line.split(/(\*\*.*?\*\*)/g);
                      return (
                        <p key={index} className="text-gray-700 leading-relaxed">
                          {parts.map((part, i) => {
                            if (part.startsWith('**') && part.endsWith('**')) {
                              return <strong key={i} className="font-semibold text-gray-900">{part.slice(2, -2)}</strong>;
                            }
                            return part;
                          })}
                        </p>
                      );
                    }
                  })}
                </div>
              </div>
            </div>
          </motion.div>

          {/* Disclaimer */}
          <motion.div variants={itemVariants}>
            <div className="bg-yellow-50 border-l-4 border-yellow-500 rounded-xl p-6">
              <div className="flex items-start gap-3">
                <AlertCircle className="text-yellow-600 flex-shrink-0 mt-1" size={24} />
                <div>
                  <h4 className="font-bold text-yellow-900 mb-2 text-lg">Important Medical Disclaimer</h4>
                  <p className="text-yellow-800 leading-relaxed">
                    This is <strong>NOT a medical or veterinary diagnosis</strong>. This information is for educational 
                    purposes only. Always consult with a qualified healthcare professional or veterinarian before taking 
                    any action based on this report. In case of emergency, seek immediate medical attention.
                  </p>
                </div>
              </div>
            </div>
          </motion.div>

          {/* Next Steps Card */}
          <motion.div variants={itemVariants}>
            <motion.div
              whileHover={{ scale: 1.02 }}
              className="bg-gradient-to-r from-cyan-500 via-blue-500 to-purple-600 rounded-2xl p-8 text-white shadow-xl"
            >
              <h3 className="text-2xl font-bold mb-4 flex items-center gap-2">
                <motion.div
                  animate={{ rotate: [0, 360] }}
                  transition={{ duration: 3, repeat: Infinity, ease: "linear" }}
                >
                  ✨
                </motion.div>
                What's Next?
              </h3>
              <ul className="space-y-3">
                <li className="flex items-start gap-3">
                  <CheckCircle className="w-6 h-6 flex-shrink-0 mt-0.5" />
                  <span>Save or print this report for your medical provider</span>
                </li>
                <li className="flex items-start gap-3">
                  <CheckCircle className="w-6 h-6 flex-shrink-0 mt-0.5" />
                  <span>Schedule an appointment within the recommended timeframe</span>
                </li>
                <li className="flex items-start gap-3">
                  <CheckCircle className="w-6 h-6 flex-shrink-0 mt-0.5" />
                  <span>Monitor symptoms and seek immediate care if condition worsens</span>
                </li>
                <li className="flex items-start gap-3">
                  <CheckCircle className="w-6 h-6 flex-shrink-0 mt-0.5" />
                  <span>Keep this report for your medical records</span>
                </li>
              </ul>
            </motion.div>
          </motion.div>
        </motion.div>
      </div>
    </div>
  );
};

export default Results;
